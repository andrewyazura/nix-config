name: Deploy Bunker
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            substituters = https://cache.andrewyazura.com/main?priority=30 https://cache.nixos.org?priority=40
            trusted-public-keys = main:T8v5SdwjNhvJowlHJFFNB1O9PbXyLrZ+vRKe7OWGCa8= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure SSH for bunker
        run: |
          ssh-keyscan -H ${{ secrets.BUNKER_HOST }} >> ~/.ssh/known_hosts
          printf 'Host bunker\n  HostName %s\n  User deploy\n  StrictHostKeyChecking accept-new\n' "${{ secrets.BUNKER_HOST }}" >> ~/.ssh/config

      - name: Setup Attic
        uses: ryanccn/attic-action@v0
        with:
          endpoint: https://cache.andrewyazura.com
          cache: main
          token: ${{ secrets.ATTIC_TOKEN }}

      - name: Check if bunker config changed
        id: check
        if: github.event_name == 'push'
        run: |
          ATTR="nixosConfigurations.bunker.config.system.build.toplevel"
          OLD_DRV=$(nix eval --raw ".?rev=$(git rev-parse HEAD~1)#${ATTR}.drvPath" 2>/dev/null) || OLD_DRV="unknown"
          NEW_DRV=$(nix eval --raw ".#${ATTR}.drvPath")
          if [[ "$OLD_DRV" == "$NEW_DRV" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Bunker config unchanged — skipping deploy"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Bunker config changed — will deploy"
          fi

      - name: Build and push to cache
        if: github.event_name == 'workflow_dispatch' || steps.check.outputs.changed == 'true'
        run: nix build .#nixosConfigurations.bunker.config.system.build.toplevel

      - name: Deploy to bunker
        if: github.event_name == 'workflow_dispatch' || steps.check.outputs.changed == 'true'
        run: nix run github:serokell/deploy-rs -- .#bunker
